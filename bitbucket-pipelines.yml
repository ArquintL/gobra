# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Copyright (c) 2011-2020 ETH Zurich.

image:
  name: gobraverifier/gobra-base:v2
  username: gobraverifier
  password: $DOCKER_HUB_PASSWORD

pipelines:
  default:
    - step:
        name: test
        caches:
          # caching for SBT (according to https://support.atlassian.com/bitbucket-cloud/docs/cache-dependencies/)
          - sbt
          - ivy2
        script:
          # save current directory such that one can return to it after setting symbolic links
          - cwd=$(pwd)
          - git clone https://github.com/viperproject/silver.git ../silver
          - git clone https://github.com/viperproject/silicon.git ../silicon
          - git clone https://github.com/viperproject/carbon.git ../carbon
          - git clone https://github.com/viperproject/viperserver.git ../viperserver
          # print some version numbers:
          - java --version
          - z3 -version
          - echo "Silver commit:" $(git -C ../silver rev-parse HEAD)
          - echo "Silicon commit:" $(git -C ../silicon rev-parse HEAD)
          - echo "Carbon commit:" $(git -C ../carbon rev-parse HEAD)
          - echo "ViperServer commit:" $(git -C ../viperserver rev-parse HEAD)
          # create symlinks:
          - cd ../silicon; ln --symbolic ../silver; cd $cwd
          - cd ../carbon; ln --symbolic ../silver; cd $cwd
          - cd ../viperserver; ln --symbolic ../silver; ln --symbolic ../silicon; ln --symbolic ../carbon; cd $cwd
          - ln --symbolic ../silver; ln --symbolic ../silicon; ln --symbolic ../carbon; ln --symbolic ../viperserver
          # execute all tests:
          - sbt test
