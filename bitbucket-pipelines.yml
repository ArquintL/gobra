image: gobraverifier/gobra-base:v2

pipelines:
  default:
    - step:
        name: test
        caches:
          # caching for SBT (according to https://support.atlassian.com/bitbucket-cloud/docs/cache-dependencies/)
          - sbt
          - ivy2
        script:
          # save current directory such that one can return to it after setting symbolic links:
          - cwd=$(pwd)
          # clone Viper dependencies:
          - git clone https://github.com/viperproject/silver.git ../silver
          - git clone https://github.com/viperproject/silicon.git ../silicon
          - git clone https://github.com/viperproject/carbon.git ../carbon
          - git clone https://github.com/viperproject/viperserver.git ../viperserver
          # print some version numbers:
          - java --version
          - z3 -version
          - echo "Silver commit:" $(git -C ../silver rev-parse HEAD)
          - echo "Silicon commit:" $(git -C ../silicon rev-parse HEAD)
          - echo "Carbon commit:" $(git -C ../carbon rev-parse HEAD)
          - echo "ViperServer commit:" $(git -C ../viperserver rev-parse HEAD)
          # create symlinks between and to Viper dependencies:
          - cd ../silicon; ln --symbolic ../silver; cd $cwd
          - cd ../carbon; ln --symbolic ../silver; cd $cwd
          - cd ../viperserver; ln --symbolic ../silver; ln --symbolic ../silicon; ln --symbolic ../carbon; cd $cwd
          - ln --symbolic ../silver; ln --symbolic ../silicon; ln --symbolic ../carbon; ln --symbolic ../viperserver
          # execute all tests:
          - sbt test
